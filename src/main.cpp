#include <Arduino.h>
#include <jbd013_api.h>
#include <SPI.h>
#include <driver/spi_master.h>
#include <HardwareSerial.h>
#include <string.h>
#include <WiFi.h>
#include <WebServer.h>
#include <FS.h>
#include <SPIFFS.h>
#include "../current_image.h"
// ÂºïËÑöÂÆö‰πâ
//#define TFT_CLK 14
#define TFT_CS0 33
#define TFT_CS1 3
#define TFT_D0 37
#define TFT_D1 40
#define TFT_D2 23
#define TFT_D3 5
// SPIÂºïËÑö
#define SPI_CLK 36  // SPIÊó∂ÈíüÂºïËÑö 3
#define SPI_MISO 37 // SPI MISOÂºïËÑö  46
#define SPI_MOSI 35 // SPI MOSIÂºïËÑö  42
#define SPI_CS 33  // SPIÁâáÈÄâÂºïËÑö spi_wr_byteÊúâBugÊâÄ‰ª•ËøôÊù°Êó†Êïà  ËøôÊù°Ë¶ÅÂú®hal_DriverÊîπ
// ‰∏≤Âè£Êò†Â∞Ñ
//HardwareSerial MySerial_esp32(1);
// ËÆæÁΩÆÈù¢ÊùøÁîªÈù¢

uint8_t screenRow = 0x28;

u8 image[22480] = {};

u8 image1[10240] = {};
u8 image2[10240] = {};
u8 image3[10240] = {};
u8 image4[10240] = {};
u8 image5[10240] = {};
u8 image6[10240] = {};
u8 image7[10240] = {};
u8 image8[10240] = {};
u8 image9[10240] = {};
u8 image10[10240] = {};
u8 image11[10240] = {};
u8 image12[10240] = {};
u8 image13[10240] = {};
u8 image14[10240] = {};
u8 image15[10240] = {};
u8 image16[10240] = {};
u8 image17[10240] = {};
u8 image18[10240] = {};
u8 image19[10240] = {};
u8 image20[10240] = {};
u8 image21[10240] = {};
u8 image22[10240] = {};
u8 image23[10240] = {};
u8 image24[10240] = {};
u8 image25[10240] = {};
u8 image26[10240] = {};
u8 image27[10240] = {};
u8 image28[10240] = {};
u8 image29[10240] = {};
u8 image30[10240] = {};

u8 fontA[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
u8 fontB[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00, 0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00, 0x00,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
u8 fontC[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00, 0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00, 0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
u8 fontD[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00, 0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00, 0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontE[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontF[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontG[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,};
u8 fontH[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontI[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
u8 fontJ[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,};
u8 fontK[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0x00, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00, 0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00, 0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00, 0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontL[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00, 0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontM[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0xFF, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0xFF, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0xFF, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0xFF, 0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0xFF, 0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0xFF, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontN[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontO[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontP[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
};
u8 fontQ[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,};
u8 fontR[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontS[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontT[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontU[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontV[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontW[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,0xFF,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
u8 fontX[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontY[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,};
u8 fontZ[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontDot[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontSpace[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};
u8 fontEndot[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font1[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font2[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font3[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font4[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font5[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font6[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font7[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font8[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font9[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

u8 font0[128] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};


int drawed = 0;

uint32_t image_len = 20480;

// ÊñáÊú¨Ê∞¥Âπ≥ÁøªËΩ¨ÊéßÂà∂ÂèòÈáè
bool textFlipEnabled = false;

// ‰∫ÆÂ∫¶ÊéßÂà∂ÂèòÈáè (ÈªòËÆ§‰∏∫ËæÉ‰Ωé‰∫ÆÂ∫¶)
u16 currentBrightness = 800;

// WiFiÂíåWebÊúçÂä°Âô®ÈÖçÁΩÆ
const char* wifi_ssid = "Hyperoptic Fibre 93B3";
const char* wifi_password = "pebdriAnU3347Y";
WebServer server(80);  // HTTPÁ´ØÂè£80

// ÂõæÂÉèÈ¢úËâ≤ÂèçËΩ¨ÂºÄÂÖ≥Ôºàtrue = ÂèçËΩ¨Ôºâ
bool invertEnabled = false;

// ËøêË°åÊó∂ÂõæÂÉèË∑ØÂæÑ‰∏éFSÁä∂ÊÄÅ
static const char* kRuntimeImagePath = "/current_image.bin"; // 640x480, 1B/px, ‰Ωé4‰ΩçÊúâÊïà
static bool fsMounted = false;
static File uploadFile;
static size_t lastUploadedSize = 0;

// ÂáΩÊï∞Â£∞Êòé
void JBD_init(void);
void drawLetter(char letter);
void drawString(const char text[], int len);
void setTextHorizontalFlip(bool enable);
void packPngScaledRowsToPanel(u8 *dest, u16 destWidth, u16 destHeight, const u8 *src, u16 srcWidth, u16 srcHeight, u16 rowStart, u16 rows, bool invert);
void refreshDisplay();
void refreshDisplayFromFS();
void setBrightness(u16 brightness);
void connectToWiFi();
void setupWebServer();
void handleRoot();
void handleBrightness();
void handleFlip();
void handleStatus();
void handleGetBrightness();
void handleGetInvertStatus();
void handleGetFlipStatus();
void handleGetWiFiStatus();
void handleInvert();
void handleDisplayPower();
void renderGreenCircle(u8 *dest, u16 widthPixels, u16 heightRows, u8 grayLevel);

// ËøêË°åÊó∂‰∏ä‰º†/Â∫îÁî®/ÊµãËØï/‰∏ãËΩΩ/FSÁä∂ÊÄÅ
void handleUploadData();
void handleUploadComplete();
void handleApply();
void handleGetRuntimeStatus();
void handleRuntimeDownload();
void handleFsStatus();
uint32_t crc32_update(uint32_t crc, const uint8_t *data, size_t len);
uint32_t computeFileCRC32(File &f);

// ÈÖçÁΩÆÂºïËÑö
void JBD_init(void)
{
  //pinMode(TFT_CLK, OUTPUT);
  pinMode(TFT_CS0, OUTPUT);
  pinMode(TFT_CS1, OUTPUT);
  pinMode(TFT_D0, OUTPUT);  // miso
  pinMode(TFT_D1, OUTPUT); // mosi
  pinMode(TFT_D2, OUTPUT);
  pinMode(TFT_D3, OUTPUT);

  digitalWrite(TFT_CS0,HIGH);
  digitalWrite(TFT_CS1,HIGH);
}

void drawLetter(char letter){
  int lenPerLetter = 8;
  int c_cursor = 0;
  int ret;
  int counter = 0;

  if(letter == 'a'){
    for(int i = 0; i < sizeof(fontA); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontA[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'b'){
    for(int i = 0; i < sizeof(fontB); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontB[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'c'){
    for(int i = 0; i < sizeof(fontC); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontC[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'd'){
    for(int i = 0; i < sizeof(fontD); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontD[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'e'){
    for(int i = 0; i < sizeof(fontE); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontE[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'f'){
    for(int i = 0; i < sizeof(fontF); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontF[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'g'){
    for(int i = 0; i < sizeof(fontG); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontG[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'h'){
    for(int i = 0; i < sizeof(fontH); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontH[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'i'){
    for(int i = 0; i < sizeof(fontI); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontI[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'j'){
    for(int i = 0; i < sizeof(fontJ); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontJ[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'k'){
    for(int i = 0; i < sizeof(fontK); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontK[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'l'){
    for(int i = 0; i < sizeof(fontL); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontL[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'm'){
    for(int i = 0; i < sizeof(fontM); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontM[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'n'){
    for(int i = 0; i < sizeof(fontN); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontN[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'o'){
    for(int i = 0; i < sizeof(fontO); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontO[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'p'){
    for(int i = 0; i < sizeof(fontP); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontP[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'q'){
    for(int i = 0; i < sizeof(fontQ); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontQ[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'r'){
    for(int i = 0; i < sizeof(fontR); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontR[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 's'){
    for(int i = 0; i < sizeof(fontS); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontS[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 't'){
    for(int i = 0; i < sizeof(fontT); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontT[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'u'){
    for(int i = 0; i < sizeof(fontU); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontU[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'v'){
    for(int i = 0; i < sizeof(fontV); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontV[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'w'){
    for(int i = 0; i < sizeof(fontW); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontW[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'x'){
    for(int i = 0; i < sizeof(fontX); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontX[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'y'){
    for(int i = 0; i < sizeof(fontY); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontY[i];
      counter++;
    }
    drawed++;
  }
  if(letter == 'z'){
    for(int i = 0; i < sizeof(fontZ); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontZ[i];
      counter++;
    }
    drawed++;
  }
  if(letter == ','){
    for(int i = 0; i < sizeof(fontDot); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontDot[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '.'){
    for(int i = 0; i < sizeof(fontEndot); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontEndot[i];
      counter++;
    }
    drawed++;
  }
  if(letter == ' '){
    for(int i = 0; i < sizeof(fontSpace); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = fontSpace[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '0'){
    for(int i = 0; i < sizeof(font0); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font0[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '1'){
    for(int i = 0; i < sizeof(font1); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font1[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '2'){
    for(int i = 0; i < sizeof(font2); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font2[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '3'){
    for(int i = 0; i < sizeof(font3); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font3[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '4'){
    for(int i = 0; i < sizeof(font4); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font4[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '5'){
    for(int i = 0; i < sizeof(font5); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font5[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '6'){
    for(int i = 0; i < sizeof(font6); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font6[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '7'){
    for(int i = 0; i < sizeof(font7); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font7[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '8'){
    for(int i = 0; i < sizeof(font8); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font8[i];
      counter++;
    }
    drawed++;
  }
  if(letter == '9'){
    for(int i = 0; i < sizeof(font9); i++){
      if( counter == 8){
        counter = 0;
        c_cursor++;
      }
      image[drawed*lenPerLetter+c_cursor*640+counter] = font9[i];
      counter++;
    }
    drawed++;
  }
}

void drawString(const char text[],int len){
  for (int i=0; i<len; i++) {
      char character = text[i];
      Serial.write(character);
      Serial.write('\r');
      Serial.write('\n');
      drawLetter(character);
  }
}

// ËÆæÁΩÆÊñáÊú¨Ê∞¥Âπ≥ÁøªËΩ¨
void setTextHorizontalFlip(bool enable) {
  textFlipEnabled = enable;
  if (enable) {
    set_mirror_mode(1); // Mirror left and right only
  } else {
    set_mirror_mode(0); // Normal display
  }
}

// ËÆæÁΩÆ‰∫ÆÂ∫¶ (ÈÄöÁî®ÂáΩÊï∞)
// ‰∫ÆÂ∫¶ËåÉÂõ¥ÂèñÂÜ≥‰∫éÂà∑Êñ∞È¢ëÁéá:
// 25Hz: 0-21331, 50Hz: 0-10664, 75Hz: 0-7109, 100Hz: 0-5331
// 125Hz: 0-4264, 150Hz: 0-3366, 175Hz: 0-2907, 200Hz: 0-2558
void setBrightness(u16 brightness) {
  Serial.print("ËÆæÁΩÆ‰∫ÆÂ∫¶: ");
  Serial.print(brightness);
  Serial.print(" (ÂΩìÂâç: ");
  Serial.print(currentBrightness);
  Serial.println(")");
  
  // ÂêØÁî®Áä∂ÊÄÅÂØÑÂ≠òÂô®ÂÜôÂÖ•
  send_cmd(SPI_WR_ENABLE);
  delay_ms(1);
  
  currentBrightness = brightness;
  wr_lum_reg(brightness);
  delay_ms(10); // ÁªôÁ°¨‰ª∂Êó∂Èó¥Â§ÑÁêÜÂëΩ‰ª§
  
  // ÈáçÊñ∞ÂêØÁî®ÊòæÁ§∫Âπ∂ÂêåÊ≠•ÔºàÂº∫Âà∂Âà∑Êñ∞‰∫ÆÂ∫¶Ôºâ
  send_cmd(SPI_DISPLAY_ENABLE);
  delay_ms(1);
  send_cmd(SPI_SYNC);
  delay_ms(1);
  
  // ËØªÂèñÂõûÂØÑÂ≠òÂô®Á°ÆËÆ§
  u16 readBack = rd_lum_reg();
  Serial.print("ËØªÂèñÂõûÁöÑ‰∫ÆÂ∫¶ÂÄº: ");
  Serial.println(readBack);
  Serial.println("‰∫ÆÂ∫¶Â∑≤ËÆæÁΩÆÂπ∂Âº∫Âà∂Âà∑Êñ∞ÊòæÁ§∫");
}



// WiFiËøûÊé•ÂáΩÊï∞
void connectToWiFi() {
  Serial.println("Ê≠£Âú®ËøûÊé•WiFi...");
  WiFi.begin(wifi_ssid, wifi_password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(1000);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println();
    Serial.println("WiFiËøûÊé•ÊàêÂäü!");
    Serial.print("IPÂú∞ÂùÄ: ");
    Serial.println(WiFi.localIP());
    Serial.print("Á´ØÂè£: 80");
    Serial.println();
  } else {
    Serial.println("WiFiËøûÊé•Â§±Ë¥•!");
  }
}

// WebÊúçÂä°Âô®Ë∑ØÁî±Â§ÑÁêÜ
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<title>ARÁúºÈïúÊéßÂà∂Èù¢Êùø</title>";
  html += "<style>body{font-family:Arial;margin:40px;background:#f0f0f0;}";
  html += ".container{max-width:600px;margin:0 auto;background:white;padding:30px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}";
  html += "h1{color:#333;text-align:center;}";
  html += ".control{margin:20px 0;padding:15px;border:1px solid #ddd;border-radius:5px;}";
  html += "button{padding:10px 20px;margin:5px;border:none;border-radius:5px;cursor:pointer;font-size:16px;}";
  html += ".btn-primary{background:#007bff;color:white;}";
  html += ".btn-success{background:#28a745;color:white;}";
  html += ".btn-warning{background:#ffc107;color:black;}";
  html += ".btn-danger{background:#dc3545;color:white;}";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<h1>ü•Ω ARÁúºÈïúÊéßÂà∂Èù¢Êùø</h1>";
  
  // WiFiÁä∂ÊÄÅÊòæÁ§∫
  html += "<div class='control' style='background:#e8f5e8;border-left:4px solid #28a745;'>";
  html += "<h3>üì° WiFiÁä∂ÊÄÅ</h3>";
  html += "<div style='display:flex;justify-content:space-between;align-items:center;'>";
  html += "<div>";
  html += "<strong>ÁΩëÁªú:</strong> " + String(wifi_ssid) + "<br>";
  html += "<strong>IPÂú∞ÂùÄ:</strong> <span id='ipAddress'>" + WiFi.localIP().toString() + "</span><br>";
  html += "<strong>‰ø°Âè∑Âº∫Â∫¶:</strong> <span id='signalStrength'>" + String(WiFi.RSSI()) + " dBm</span>";
  html += "</div>";
  html += "<div style='font-size:24px;color:#28a745;'>üì∂</div>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='control'><h3>üí° ‰∫ÆÂ∫¶ÊéßÂà∂</h3>";
  html += "<div style='margin-bottom:15px;'>ÂΩìÂâç‰∫ÆÂ∫¶: <span id='currentBrightness' style='font-weight:bold;color:#007bff;'>--</span></div>";
  html += "<div style='display:flex;align-items:center;gap:8px;margin-bottom:10px;'>";
  html += "<input id='brightnessInput' type='number' min='0' max='65535' step='1' placeholder='0-65535' style='width:150px;padding:8px;font-size:14px;'>";
  html += "<button class='btn-primary' onclick=\"setBrightnessValue()\" style='padding:8px 15px;'>ËÆæÁΩÆ‰∫ÆÂ∫¶</button>";
  html += "</div>";
  html += "<div style='font-size:12px;color:#666;margin-top:5px;'>Âª∫ËÆÆËåÉÂõ¥: 20-2000ÔºåÊúÄÂ§ßÂÄº: 65535</div>";
  html += "</div>";

  // È¢úËâ≤ÂèçËΩ¨
  html += "<div class='control'><h3>üé® È¢úËâ≤ÂèçËΩ¨</h3>";
  html += "<div style='margin-bottom:10px;'>ÂΩìÂâçÁä∂ÊÄÅ: <span id='invertStatus' style='font-weight:bold;color:#007bff;'>--</span></div>";
  html += "<button class='btn-primary' onclick=\"toggleInvert(true)\">ÂêØÁî®ÂèçËΩ¨</button>";
  html += "<button class='btn-danger' onclick=\"toggleInvert(false)\">Á¶ÅÁî®ÂèçËΩ¨</button>";
  html += "</div>";
  
  html += "<script>";
  html += "function setBrightnessValue() {";
  html += "  const el=document.getElementById('brightnessInput');";
  html += "  let v=parseInt(el.value||'0'); if(isNaN(v)) v=0; if(v<0) v=0; if(v>65535) v=65535;";
  html += "  if(v>2000) { if(!confirm('‰∫ÆÂ∫¶ÂÄºËæÉÈ´ò (' + v + ')ÔºåÂèØËÉΩÂØºËá¥ÊòæÁ§∫Âô®ËøáÁÉ≠„ÄÇÁ°ÆÂÆöË¶ÅËÆæÁΩÆÂêóÔºü')) return; }";
  html += "  fetch('/brightness?value=' + v).then(() => updateBrightness());";
  html += "}";
  html += "function updateBrightness() {";
  html += "  fetch('/api/brightness').then(r => r.json()).then(data => {";
  html += "    document.getElementById('currentBrightness').textContent = data.current + ' (reg: ' + data.register + ')';";
  html += "  });";
  html += "}";
  html += "function toggleInvert(enable) {";
  html += "  fetch('/invert?enable=' + enable).then(() => updateInvertStatus());";
  html += "}";
  html += "function updateInvertStatus() {";
  html += "  fetch('/api/invert-status').then(r => r.json()).then(data => {";
  html += "    document.getElementById('invertStatus').textContent = data.status;";
  html += "  });";
  html += "}";
  html += "function toggleFlip(enable) {";
  html += "  fetch('/flip?enable=' + enable).then(() => updateFlipStatus());";
  html += "}";
  html += "function updateFlipStatus() {";
  html += "  fetch('/api/flip-status').then(r => r.json()).then(data => {";
  html += "    document.getElementById('flipStatus').textContent = data.status;";
  html += "  });";
  html += "}";

  html += "updateBrightness(); updateInvertStatus(); updateFlipStatus();";
  html += "setInterval(updateBrightness, 2000); setInterval(updateInvertStatus, 2000); setInterval(updateFlipStatus, 2000);";
  html += "function displayImage() {";
  html += "  fetch('/display-image').then(r => r.text()).then(msg => alert(msg));";
  html += "}";
  html += "function updateWiFiStatus() {";
  html += "  fetch('/api/wifi-status').then(r => r.json()).then(data => {";
  html += "    document.getElementById('signalStrength').textContent = data.rssi + ' dBm';";
  html += "  }).catch(e => console.log('WiFi status update failed'));";
  html += "}";
  html += "setInterval(updateWiFiStatus, 5000);"; // ÊØè5ÁßíÊõ¥Êñ∞WiFiÁä∂ÊÄÅ
  // ‰∏ä‰º†&Ë∞ÉËØïÊ≠•È™§
  html += "function stepMount(){fetch('/api/fs-status').then(r=>r.json()).then(d=>alert('FS mounted:'+d.mounted+' total:'+d.total+' used:'+d.used)).catch(()=>alert('FSÁä∂ÊÄÅÊé•Âè£‰∏çÂèØÁî®'));}";
  html += "function stepRuntimeStatus(){fetch('/api/runtime-status').then(r=>r.json()).then(d=>alert('available:'+d.available+' size:'+d.size)).catch(()=>alert('runtime-status ‰∏çÂèØÁî®'));}";
  html += "function stepUpload(){const f=document.getElementById('rtimg').files[0]; if(!f){alert('ËØ∑ÈÄâÊã© .bin');return;} const fd=new FormData(); fd.append('file', f); fetch('/upload',{method:'POST',body:fd}).then(r=>r.text()).then(t=>alert(t)).catch(e=>alert('‰∏ä‰º†Â§±Ë¥•:'+e));}";
  html += "function stepApply(){fetch('/apply',{method:'POST'}).then(r=>r.text()).then(t=>alert(t)).catch(e=>alert('applyÂ§±Ë¥•:'+e));}";
  html += "function stepDownload(){window.open('/runtime.bin','_blank');}";
  html += "function refreshRuntimeCard(){fetch('/api/runtime-status').then(r=>r.json()).then(d=>{document.getElementById('rtinfo').textContent=d.available?('ÂèØÁî®, '+d.size+' Â≠óËäÇ'):'Êú™ÊâæÂà∞';});}";
  html += "function stepFormat(){if(confirm('Ê†ºÂºèÂåñSPIFFSÂ∞ÜÊ∏ÖÁ©∫Êñá‰ª∂ÔºåÁ°ÆÂÆöÔºü')){fetch('/api/fs-format',{method:'POST'}).then(r=>r.text()).then(t=>alert(t)).catch(()=>alert('formatÂ§±Ë¥•'));}}";
  html += "</script>";
  
  html += "<div class='control'><h3>üîÑ ÊòæÁ§∫ÁøªËΩ¨</h3>";
  html += "<div style='margin-bottom:10px;'>ÂΩìÂâçÁä∂ÊÄÅ: <span id='flipStatus' style='font-weight:bold;color:#007bff;'>--</span></div>";
  html += "<button class='btn-primary' onclick=\"toggleFlip(true)\">ÂêØÁî®Ê∞¥Âπ≥ÁøªËΩ¨</button>";
  html += "<button class='btn-danger' onclick=\"toggleFlip(false)\">Á¶ÅÁî®Ê∞¥Âπ≥ÁøªËΩ¨</button>";
  html += "</div>";
  
  // ËøêË°åÊó∂ÂõæÂÉè - Ë∞ÉËØïÊ≠•È™§Èù¢Êùø
  html += "<div class='control'><h3>üß™ ‰∏ä‰º†Ë∞ÉËØïÊ≠•È™§</h3>";
  html += "<div>ËøêË°åÊó∂Êñá‰ª∂Áä∂ÊÄÅ: <span id='rtinfo'>--</span></div>";
  html += "<div style='margin-top:8px'><input id='rtimg' type='file' accept='.bin'></div>";
  html += "<div style='margin-top:8px'>";
  html += "<button class='btn-warning' onclick=\"stepMount()\">1) Ê£ÄÊü•FS</button>";
  html += "<button class='btn-warning' onclick=\"stepRuntimeStatus()\">2) Êü•ÁúãÁä∂ÊÄÅ</button>";
  html += "<button class='btn-success' onclick=\"stepUpload()\">3) ‰∏ä‰º†.bin</button>";
  html += "<button class='btn-primary' onclick=\"stepApply()\">4) Â∫îÁî®ÂõæÂÉè</button>";
  html += "<button class='btn-primary' onclick=\"stepDownload()\">5) ‰∏ãËΩΩÊ†∏ÂØπ</button>";
  html += "<button class='btn-warning' onclick=\"refreshRuntimeCard()\">Âà∑Êñ∞Áä∂ÊÄÅ</button>";
  html += "<button class='btn-danger' onclick=\"stepFormat()\">Ê†ºÂºèÂåñSPIFFS</button>";
  html += "</div></div>";
  


  // ÊòæÁ§∫ÁîµÊ∫ê
  html += "<div class='control'><h3>üñ•Ô∏è Â±èÂπïÁîµÊ∫ê</h3>";
  html += "<button class='btn-primary' onclick=\"fetch('/display-power?on=1')\">ÂºÄÂêØÊòæÁ§∫</button>";
  html += "<button class='btn-danger' onclick=\"fetch('/display-power?on=0')\">ÂÖ≥Èó≠ÊòæÁ§∫</button>";
  html += "</div>";
  
  html += "<div class='control'><h3>üìä Áä∂ÊÄÅ‰ø°ÊÅØ</h3>";
  html += "<button class='btn-primary' onclick=\"window.location.href='/status'\">Êü•ÁúãÁä∂ÊÄÅ</button>";
  html += "</div>";
  
  html += "</div></body></html>";
  
  server.send(200, "text/html", html);
}

void handleBrightness() {
  String value = server.arg("value");
  
  if (value.length()) {
    int v = value.toInt();
    if (v < 0) v = 0; 
    if (v > 65535) v = 65535;  // 16‰ΩçÂØÑÂ≠òÂô®ÊúÄÂ§ßÂÄº
    
    Serial.print("ËÆæÁΩÆËá™ÂÆö‰πâ‰∫ÆÂ∫¶: ");
    Serial.println(v);
    
    setBrightness((u16)v);
    server.send(200, "text/plain", String("‰∫ÆÂ∫¶ËÆæÁΩÆ‰∏∫ ") + v);
  } else {
    Serial.println("Áº∫Â∞ë‰∫ÆÂ∫¶ÂèÇÊï∞");
    server.send(400, "text/plain", "Áº∫Â∞ë‰∫ÆÂ∫¶ÂèÇÊï∞");
  }
}

void handleFlip() {
  String enable = server.arg("enable");
  
  if (enable == "true") {
    setTextHorizontalFlip(true);
    server.send(200, "text/plain", "Ê∞¥Âπ≥ÁøªËΩ¨Â∑≤ÂêØÁî®");
  } else if (enable == "false") {
    setTextHorizontalFlip(false);
    server.send(200, "text/plain", "Ê∞¥Âπ≥ÁøªËΩ¨Â∑≤Á¶ÅÁî®");
  } else {
    server.send(400, "text/plain", "Êó†ÊïàÁöÑÁøªËΩ¨ÂèÇÊï∞");
  }
}

// È¢úËâ≤ÂèçËΩ¨ÊéßÂà∂
// ÈáçÊñ∞ÊòæÁ§∫ÂΩìÂâçÂõæÂÉèÔºàÁî®‰∫éÂèçËΩ¨„ÄÅÁøªËΩ¨Á≠âËÆæÁΩÆÂèòÊõ¥ÂêéÁöÑÂà∑Êñ∞Ôºâ
void refreshDisplay() {
  const u16 panelWidth = 640;
  const u16 panelHeight = 480;
  const u16 chunkRows = 60; // 480/60=8Êï¥ÂùóÔºåÈÅøÂÖçËæπÁïå‰º™ÂΩ±
  const u16 bytesPerRow = panelWidth / 2;
  u16 rowStart = 0;
  
  while (rowStart < panelHeight) {
    u16 rowsNow = (panelHeight - rowStart) > chunkRows ? chunkRows : (panelHeight - rowStart);
    memset(image, 0, (size_t)bytesPerRow * (size_t)rowsNow);
    packPngScaledRowsToPanel(image, panelWidth, panelHeight,
                             current_image_data, current_image_width, current_image_height,
                             rowStart, rowsNow, invertEnabled);
    u32 lenBytes = (u32)bytesPerRow * (u32)rowsNow;
    display_image(image, lenBytes, 0, (u16)rowStart);
    rowStart += rowsNow;
  }
}

// ‰ªéSPIFFSËØªÂèñËøêË°åÊó∂ÂõæÂÉèÂπ∂Âà∑Êñ∞
void refreshDisplayFromFS() {
  if (!fsMounted || !SPIFFS.exists(kRuntimeImagePath)) {
    refreshDisplay();
    return;
  }
  const u16 panelWidth = 640;
  const u16 panelHeight = 480;
  const u16 chunkRows = 40;
  const u16 srcBytesPerRow = panelWidth; // 1B/px
  const u16 dstBytesPerRow = panelWidth / 2; // 2px/byte

  File f = SPIFFS.open(kRuntimeImagePath, "r");
  if (!f) { refreshDisplay(); return; }
  size_t expected = (size_t)panelWidth * (size_t)panelHeight;
  if ((size_t)f.size() < expected) { f.close(); refreshDisplay(); return; }

  std::unique_ptr<u8[]> src(new u8[(size_t)srcBytesPerRow * (size_t)chunkRows]);
  std::unique_ptr<u8[]> dst(new u8[(size_t)dstBytesPerRow * (size_t)chunkRows]);

  u16 rowStart = 0;
  while (rowStart < panelHeight) {
    u16 rowsNow = (panelHeight - rowStart) > chunkRows ? chunkRows : (panelHeight - rowStart);
    size_t offset = (size_t)rowStart * (size_t)srcBytesPerRow;
    f.seek((u32)offset, SeekSet);
    size_t toRead = (size_t)srcBytesPerRow * (size_t)rowsNow;
    size_t n = f.read((uint8_t*)src.get(), toRead);
    if (n != toRead) break;
    for (u16 ry = 0; ry < rowsNow; ry++) {
      const u8* s = src.get() + (size_t)ry * (size_t)srcBytesPerRow;
      u8* d = dst.get() + (size_t)ry * (size_t)dstBytesPerRow;
      for (u16 x = 0; x < panelWidth; x += 2) {
        u8 v0 = s[x] & 0x0F; u8 v1 = s[x+1] & 0x0F;
        if (invertEnabled) { v0 = (u8)(0x0F - v0); v1 = (u8)(0x0F - v1); }
        d[x >> 1] = (u8)((v0 << 4) | v1);
      }
    }
    u32 lenBytes = (u32)dstBytesPerRow * (u32)rowsNow;
    display_image((u8*)dst.get(), lenBytes, 0, (u16)rowStart);
    rowStart += rowsNow;
  }
  f.close();
}

void handleInvert() {
  String enable = server.arg("enable");
  if (enable == "true") {
    invertEnabled = true;
    Serial.println("ÂèçËΩ¨Â∑≤ÂêØÁî®");
    refreshDisplay(); // ÈáçÊñ∞ÊòæÁ§∫ÂõæÂÉè
    server.send(200, "text/plain", "invert on");
  } else if (enable == "false") {
    invertEnabled = false;
    Serial.println("ÂèçËΩ¨Â∑≤Á¶ÅÁî®");
    refreshDisplay(); // ÈáçÊñ∞ÊòæÁ§∫ÂõæÂÉè
    server.send(200, "text/plain", "invert off");
  } else {
    server.send(400, "text/plain", "invalid param");
  }
}

// ÂºÄÂÖ≥ÊòæÁ§∫ÁîµÊ∫ê
void handleDisplayPower() {
  String on = server.arg("on");
  if (on == "1") {
    send_cmd(SPI_DISPLAY_ENABLE);
    send_cmd(SPI_SYNC);
    server.send(200, "text/plain", "display on");
  } else if (on == "0") {
    send_cmd(SPI_DISPLAY_DISABLE);
    send_cmd(SPI_SYNC);
    server.send(200, "text/plain", "display off");
  } else {
    server.send(400, "text/plain", "invalid param");
  }
}

void handleStatus() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
  html += "<title>AR Device Status</title>";
  html += "<style>body{font-family:Arial;margin:40px;background:#f0f0f0;}";
  html += ".container{max-width:600px;margin:0 auto;background:white;padding:30px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}";
  html += "h1{color:#333;text-align:center;}";
  html += ".status-item{margin:15px 0;padding:10px;background:#f8f9fa;border-left:4px solid #007bff;border-radius:4px;}";
  html += ".label{font-weight:bold;color:#495057;}";
  html += ".value{color:#28a745;margin-left:10px;}";
  html += ".refresh-btn{background:#007bff;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;margin-top:20px;}";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<h1>üìä AR Device Status</h1>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üåê WiFi Network:</span>";
  html += "<span class='value'>" + String(wifi_ssid) + "</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üîó IP Address:</span>";
  html += "<span class='value'>" + WiFi.localIP().toString() + "</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üì∂ Signal Strength:</span>";
  html += "<span class='value'>" + String(WiFi.RSSI()) + " dBm</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üí° Current Brightness:</span>";
  html += "<span class='value'>" + String(currentBrightness) + "</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üîÑ Horizontal Flip:</span>";
  html += "<span class='value'>" + String(textFlipEnabled ? "Enabled" : "Disabled") + "</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>‚è±Ô∏è Uptime:</span>";
  html += "<span class='value'>" + String(millis() / 1000) + " seconds</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üíæ Free RAM:</span>";
  html += "<span class='value'>" + String(ESP.getFreeHeap()) + " bytes</span>";
  html += "</div>";
  
  html += "<div class='status-item'>";
  html += "<span class='label'>üíΩ Flash Size:</span>";
  html += "<span class='value'>" + String(ESP.getFlashChipSize()) + " bytes</span>";
  html += "</div>";
  {
    bool available = fsMounted && SPIFFS.exists(kRuntimeImagePath);
    size_t sz = 0;
    if (available) { File tf = SPIFFS.open(kRuntimeImagePath, "r"); if (tf) { sz = tf.size(); tf.close(); } }
    html += "<div class='status-item'>";
    html += "<span class='label'>üñºÔ∏è Runtime Image:</span>";
    html += "<span class='value'>" + String(available ? "Available" : "Not found") + (available ? (String(", ") + String(sz) + " bytes") : String("")) + "</span>";
    html += "</div>";
  }
  
  html += "<button class='refresh-btn' onclick='window.location.reload()'>üîÑ Refresh</button>";
  html += "<button class='refresh-btn' onclick='window.location.href=\"/\"' style='margin-left:10px;background:#28a745;'>üè† Home</button>";
  html += "</div></body></html>";
  
  server.send(200, "text/html", html);
}

void handleGetBrightness() {
  String json = "{";
  json += "\"current\": " + String(currentBrightness) + ",";
  json += "\"register\": " + String(rd_lum_reg()) + ",";
  json += "\"timestamp\": " + String(millis());
  json += "}";
  
  server.send(200, "application/json", json);
}

void handleGetInvertStatus() {
  String json = "{";
  json += "\"enabled\": " + String(invertEnabled ? "true" : "false") + ",";
  json += "\"status\": \"" + String(invertEnabled ? "ÂêØÁî®" : "Á¶ÅÁî®") + "\"";
  json += "}";
  server.send(200, "application/json", json);
}

void handleGetFlipStatus() {
  String json = "{";
  json += "\"enabled\": " + String(textFlipEnabled ? "true" : "false") + ",";
  json += "\"status\": \"" + String(textFlipEnabled ? "ÂêØÁî®" : "Á¶ÅÁî®") + "\"";
  json += "}";
  server.send(200, "application/json", json);
}

void handleGetWiFiStatus() {
  String json = "{";
  json += "\"ssid\": \"" + String(wifi_ssid) + "\",";
  json += "\"ip\": \"" + WiFi.localIP().toString() + "\",";
  json += "\"rssi\": " + String(WiFi.RSSI()) + ",";
  json += "\"connected\": " + String(WiFi.status() == WL_CONNECTED ? "true" : "false") + ",";
  json += "\"timestamp\": " + String(millis());
  json += "}";
  
  server.send(200, "application/json", json);
}

// ‰∏ä‰º†Â§ÑÁêÜÔºöÊï∞ÊçÆÂùóÂÜôÂÖ•
void handleUploadData() {
  HTTPUpload& up = server.upload();
  if (up.status == UPLOAD_FILE_START) {
    if (!fsMounted) { Serial.println("/upload: FSÊú™ÊåÇËΩΩ"); return; }
    if (SPIFFS.exists(kRuntimeImagePath)) SPIFFS.remove(kRuntimeImagePath);
    uploadFile = SPIFFS.open(kRuntimeImagePath, "w");
    lastUploadedSize = 0;
    Serial.printf("/upload: start '%s'\n", up.filename.c_str());
  } else if (up.status == UPLOAD_FILE_WRITE) {
    if (uploadFile) {
      uploadFile.write(up.buf, up.currentSize);
      lastUploadedSize += up.currentSize;
    }
  } else if (up.status == UPLOAD_FILE_END) {
    if (uploadFile) uploadFile.close();
    Serial.printf("/upload: end, total=%u bytes\n", (unsigned)lastUploadedSize);
  } else if (up.status == UPLOAD_FILE_ABORTED) {
    if (uploadFile) { uploadFile.close(); }
    if (SPIFFS.exists(kRuntimeImagePath)) { SPIFFS.remove(kRuntimeImagePath); }
    Serial.println("/upload: aborted");
  }
}

// ‰∏ä‰º†ÂÆåÊàêÂêéÁöÑÂìçÂ∫î
void handleUploadComplete() {
  if (!fsMounted) { server.send(500, "text/plain", "FSÊú™ÊåÇËΩΩ"); return; }
  if (SPIFFS.exists(kRuntimeImagePath)) {
    File f = SPIFFS.open(kRuntimeImagePath, "r");
    size_t sz = f ? f.size() : 0; if (f) f.close();
    if (sz == 0) server.send(500, "text/plain", "‰∏ä‰º†Â§±Ë¥•: Á©∫Êñá‰ª∂");
    else server.send(200, "text/plain", String("‰∏ä‰º†ÂÆåÊàê, Â§ßÂ∞è ") + String(sz) + " Â≠óËäÇ");
  } else {
    server.send(500, "text/plain", "‰∏ä‰º†Â§±Ë¥•");
  }
}

// Â∫îÁî®ËøêË°åÊó∂ÂõæÂÉè
void handleApply() {
  if (!fsMounted) { server.send(500, "text/plain", "FSÊú™ÊåÇËΩΩ"); return; }
  if (!SPIFFS.exists(kRuntimeImagePath)) { server.send(404, "text/plain", "Êú™ÊâæÂà∞ËøêË°åÊó∂ÂõæÂÉè"); return; }
  refreshDisplayFromFS();
  server.send(200, "text/plain", "Â∑≤Â∫îÁî®ËøêË°åÊó∂ÂõæÂÉè");
}

// ‰∏ãËΩΩÂΩìÂâçbin
void handleRuntimeDownload() {
  if (!fsMounted || !SPIFFS.exists(kRuntimeImagePath)) { server.send(404, "text/plain", "Êú™ÊâæÂà∞"); return; }
  File f = SPIFFS.open(kRuntimeImagePath, "r");
  server.streamFile(f, "application/octet-stream");
  f.close();
}

// ËøêË°åÊó∂Êñá‰ª∂Áä∂ÊÄÅ
void handleGetRuntimeStatus() {
  bool available = fsMounted && SPIFFS.exists(kRuntimeImagePath);
  size_t sz = 0;
  if (available) { File f = SPIFFS.open(kRuntimeImagePath, "r"); if (f) { sz = f.size(); f.close(); } }
  String json = "{";
  json += "\"available\": " + String(available ? "true" : "false") + ",";
  json += "\"size\": " + String(sz);
  json += "}";
  server.send(200, "application/json", json);
}

// FSÁä∂ÊÄÅ
void handleFsStatus() {
  String json = "{";
  json += "\"mounted\": "; json += fsMounted ? "true" : "false"; json += ",";
  if (fsMounted) {
    size_t total = SPIFFS.totalBytes();
    size_t used = SPIFFS.usedBytes();
    json += "\"total\": "; json += String(total); json += ",";
    json += "\"used\": "; json += String(used);
  } else {
    json += "\"total\": 0, \"used\": 0";
  }
  json += "}";
  server.send(200, "application/json", json);
}

// CRC32 ËÆ°ÁÆó
uint32_t crc32_update(uint32_t crc, const uint8_t *data, size_t len) {
  crc = ~crc;
  for (size_t i = 0; i < len; i++) {
    crc ^= data[i];
    for (int j = 0; j < 8; j++) {
      uint32_t mask = -(crc & 1u);
      crc = (crc >> 1) ^ (0xEDB88320u & mask);
    }
  }
  return ~crc;
}

uint32_t computeFileCRC32(File &f) {
  const size_t BUFSZ = 2048;
  uint8_t buf[BUFSZ];
  uint32_t crc = 0;
  f.seek(0, SeekSet);
  while (true) {
    size_t n = f.read(buf, BUFSZ);
    if (n == 0) break;
    crc = crc32_update(crc, buf, n);
  }
  return crc;
}
















void setupWebServer() {
  server.on("/", handleRoot);
  server.on("/brightness", handleBrightness);
  server.on("/flip", handleFlip);
  server.on("/display-power", handleDisplayPower);
  server.on("/status", handleStatus);
  server.on("/api/brightness", handleGetBrightness);
  server.on("/api/invert-status", handleGetInvertStatus);
  server.on("/api/flip-status", handleGetFlipStatus);
  server.on("/invert", handleInvert);
  server.on("/api/wifi-status", handleGetWiFiStatus);

  // ËøêË°åÊó∂ÂõæÂÉè‰∏ä‰º†/Â∫îÁî®/‰∏ãËΩΩ/Áä∂ÊÄÅ
  server.on("/upload", HTTP_POST, handleUploadComplete, handleUploadData);
  server.on("/apply", HTTP_POST, handleApply);
  server.on("/api/runtime-status", HTTP_GET, handleGetRuntimeStatus);
  server.on("/runtime.bin", HTTP_GET, handleRuntimeDownload);
  server.on("/api/fs-status", HTTP_GET, handleFsStatus);
  server.on("/api/fs-format", HTTP_POST, [](){
    bool ok = false;
    if (fsMounted) {
      ok = SPIFFS.format();
    }
    server.send(ok ? 200 : 500, "text/plain", ok ? "FSÊ†ºÂºèÂåñÂÆåÊàê" : "FSÊ†ºÂºèÂåñÂ§±Ë¥•/Êú™ÊåÇËΩΩ");
  });

  
  server.begin();
  Serial.println("WebÊúçÂä°Âô®ÂêØÂä®ÊàêÂäü!");
  Serial.print("ËÆøÈóÆÂú∞ÂùÄ: http://");
  Serial.println(WiFi.localIP());
}

// ÁîüÊàêÂ∏¶ÈÄèÊòéËÉåÊôØÁöÑÁªøËâ≤ÂúÜÂΩ¢Âà∞Â∏ßÁºìÂÜ≤Ôºà4bitÁÅ∞Â∫¶ÔºåÊØèÂ≠óËäÇ‰∏§‰∏™ÂÉèÁ¥†Ôºâ
void renderGreenCircle(u8 *dest, u16 widthPixels, u16 heightRows, u8 grayLevel) {
  u8 level = (grayLevel > 15) ? 15 : grayLevel;
  u16 bytesPerRow = widthPixels / 2; // ÊØèÂ≠óËäÇ‰∏§‰∏™ÂÉèÁ¥†
  float cx = (float)widthPixels * 0.5f;
  float cy = (float)heightRows * 0.5f;
  float radius = (heightRows < widthPixels ? (float)heightRows : (float)widthPixels) * 0.35f;
  float r2 = radius * radius;

  for (u16 y = 0; y < heightRows; y++) {
    for (u16 x = 0; x < widthPixels; x += 2) {
      float dx0 = (float)x - cx;
      float dy0 = (float)y - cy;
      float dx1 = (float)(x + 1) - cx;
      float dy1 = dy0;
      bool on0 = (dx0 * dx0 + dy0 * dy0) <= r2;
      bool on1 = (dx1 * dx1 + dy1 * dy1) <= r2;
      u8 hi = on0 ? level : 0;
      u8 lo = on1 ? level : 0;
      dest[y * bytesPerRow + (x >> 1)] = (hi << 4) | lo;
    }
  }
}

// Â∞ÜÊØèÂÉèÁ¥†1Â≠óËäÇ(0..15)ÁöÑPNGË°åÂùóÊâìÂåÖ‰∏∫Èù¢Êùø4bit/ÂÉèÁ¥†ÁºìÂÜ≤ÔºàÊØèÂ≠óËäÇ2ÂÉèÁ¥†ÔºåË°åÂÆΩÂõ∫ÂÆödestWidth=640Ôºâ
void packPngRowsToPanel(u8 *dest, u16 destWidth, const u8 *src, u16 srcWidth, u16 rowStart, u16 rows) {
  u16 bytesPerRow = destWidth / 2;
  for (u16 ry = 0; ry < rows; ry++) {
    u16 y = rowStart + ry;
    const u8 *srcRow = src + (u32)y * (u32)srcWidth;
    u8 *dstRow = dest + (u32)ry * (u32)bytesPerRow;
    for (u16 x = 0; x < destWidth; x += 2) {
      u8 g0 = 0, g1 = 0;
      if (x < srcWidth) {
        u8 v0 = srcRow[x] & 0x0F;
        g0 = (u8)(0x0F - v0); // invert: 0 -> 15 (bright), 15 -> 0 (black)
      }
      if ((x + 1) < srcWidth) {
        u8 v1 = srcRow[x + 1] & 0x0F;
        g1 = (u8)(0x0F - v1);
      }
      dstRow[x >> 1] = (g0 << 4) | g1;
    }
  }
}

// Â∞ÜPNGÁº©ÊîæÂà∞Â±èÂπïÂ∞∫ÂØ∏ÔºàÊúÄËøëÈÇªÔºâÔºåÂπ∂ÊåâË°åÂùóÊâìÂåÖÔºà4bit/ÂÉèÁ¥†Ôºå0..15Ôºâ„ÄÇ
void packPngScaledRowsToPanel(u8 *dest,
                              u16 destWidth,
                              u16 destHeight,
                              const u8 *src,
                              u16 srcWidth,
                              u16 srcHeight,
                              u16 rowStart,
                              u16 rows,
                              bool invert) {
  u16 bytesPerRow = destWidth / 2;
  for (u16 ry = 0; ry < rows; ry++) {
    u16 yDst = rowStart + ry;
    u32 ySrc = ((u32)yDst * (u32)srcHeight) / (u32)destHeight;
    if (ySrc >= srcHeight) ySrc = srcHeight - 1;
    const u8 *srcRow = src + (u32)ySrc * (u32)srcWidth;
    u8 *dstRow = dest + (u32)ry * (u32)bytesPerRow;
    for (u16 x = 0; x < destWidth; x += 2) {
      u32 x0Src = ((u32)x * (u32)srcWidth) / (u32)destWidth;
      if (x0Src >= srcWidth) x0Src = srcWidth - 1;
      u32 x1Src = ((u32)(x + 1) * (u32)srcWidth) / (u32)destWidth;
      if (x1Src >= srcWidth) x1Src = srcWidth - 1;
      u8 v0 = srcRow[x0Src] & 0x0F;
      u8 v1 = srcRow[x1Src] & 0x0F;
      if (invert) {
        v0 = (u8)(0x0F - v0);
        v1 = (u8)(0x0F - v1);
      }
      dstRow[x >> 1] = (v0 << 4) | v1;
    }
  }
}

// u32 ID=read_id();
void setup()
{

  // ÂàùÂßãÂåñÂºïËÑö
  //JBD_init();
  // ÈÖçÁΩÆSPIËÆæÁΩÆ
  SPI.begin(SPI_CLK, SPI_MISO, SPI_MOSI, SPI_CS);
  //SPI.begin();
  SPI.setBitOrder(MSBFIRST);           // Êï∞ÊçÆ‰ΩçÈ°∫Â∫èÔºåÊúÄÈ´òÊúâÊïà‰ΩçÂÖà‰º†Ëæì
  SPI.setDataMode(SPI_MODE0);          // Êó∂ÈíüÁõ∏‰ΩçÂíåÊûÅÊÄßÔºåÊ®°Âºè
  SPI.setClockDivider(SPI_CLOCK_DIV4); //
  pinMode(SPI_CS, OUTPUT);
  digitalWrite(SPI_CS, HIGH); // ÈªòËÆ§Á¶ÅÁî®‰ªéËÆæÂ§á
  Serial.begin(115200);
  Serial.println("AR-Ldc-Vision ÂàùÂßãÂåñ‰∏≠...");
  delay_ms(10);
  // ÊåÇËΩΩSPIFFS
  if (!SPIFFS.begin(true)) {
    Serial.println("SPIFFS ÊåÇËΩΩÂ§±Ë¥•");
    fsMounted = false;
  } else {
    fsMounted = true;
    Serial.println("SPIFFS Â∑≤ÊåÇËΩΩ");
  }
  //u32 ID = read_id();
  //u8 Stus = rd_status_reg(SPI_RD_STATUS_REG2);
  //u16 lum = rd_lum_reg();
  //send_cmd(SPI_SELF_TEST_ALL_ON);
  //send_cmd(SPI_SYNC);
  //get_temperature_sensor_data(0x26);
  //u8 elc = rd_cur_reg();
  //lum = rd_lum_reg();
  //u16 ofs=rd_offset_reg();
  //delay_ms(10);
  // ÂàùÂßãÂåñÈù¢Êùø
  panel_init();
  
  // ËÆæÁΩÆÊñáÊú¨Ê∞¥Âπ≥ÁøªËΩ¨ (true = ÁøªËΩ¨, false = Ê≠£Â∏∏)
  setTextHorizontalFlip(false);
  
  // ËÆæÁΩÆÈªòËÆ§‰∫ÆÂ∫¶
  setBrightness(50);  // ÂêØÂä®Êó∂‰ΩøÁî®ÈÄÇ‰∏≠ÁöÑÈªòËÆ§‰∫ÆÂ∫¶  

  // ËøûÊé•WiFiÂπ∂ÂêØÂä®WebÊúçÂä°Âô®
  connectToWiFi();
  if (WiFi.status() == WL_CONNECTED) {
    setupWebServer();
  }  

  // ‰ΩøÁî®È¢ÑÂ§ÑÁêÜÂêéÁöÑÊú¨Âú∞ÂõæÂÉèÔºà640x480ÔºâÂàÜÂùóÂÜôÂÖ•ÔºåÈÅøÂÖçÁº©Êîæ‰∏éÂèçÁõ∏
  const u16 panelWidth = 640;
  const u16 panelHeight = 480;
  const u16 chunkRows = 60; // 480/60=8Êï¥ÂùóÔºåÈÅøÂÖçËæπÁïå‰º™ÂΩ±
  const u16 bytesPerRow = panelWidth / 2;
  u16 rowStart = 0;
  while (rowStart < panelHeight) {
    u16 rowsNow = (panelHeight - rowStart) > chunkRows ? chunkRows : (panelHeight - rowStart);
    memset(image, 0, (size_t)bytesPerRow * (size_t)rowsNow);
    packPngScaledRowsToPanel(image, panelWidth, panelHeight,
                             current_image_data, current_image_width, current_image_height,
                             rowStart, rowsNow, invertEnabled);
    u32 lenBytes = (u32)bytesPerRow * (u32)rowsNow;
    display_image(image, lenBytes, 0, (u16)rowStart);
    rowStart += rowsNow;
  }
}

void loop()
{
  // Â§ÑÁêÜWebÊúçÂä°Âô®ËØ∑Ê±Ç
  server.handleClient();

  // display_image(image, image_len);

  /*
  ============================
  ‰∫ÆÂ∫¶ÊéßÂà∂Á§∫‰æã - ÂèØ‰ª•Âú®ËøôÈáåÂä®ÊÄÅË∞ÉÊï¥‰∫ÆÂ∫¶
  ============================
  */
  // Á§∫‰æã: Âä®ÊÄÅ‰∫ÆÂ∫¶Ë∞ÉÊï¥ (ÂèñÊ∂àÊ≥®Èáä‰ª•ÂêØÁî®)
  // static unsigned long lastBrightnessChange = 0;
  // if (millis() - lastBrightnessChange > 5000) { // ÊØè5ÁßíÊîπÂèò‰∏ÄÊ¨°
  //   static bool lowBrightness = true;
  //   if (lowBrightness) {
  //     setBrightnessMedium();
  //   } else {
  //     setBrightnessLow();
  //   }
  //   lowBrightness = !lowBrightness;
  //   lastBrightnessChange = millis();
  // }

  // ÁõëÊéßÂΩìÂâçËÆæÁΩÆ (ÂèØÈÄâ - ÂèñÊ∂àÊ≥®Èáä‰ª•Âú®‰∏≤Âè£Êü•Áúã)
  // u8 elc = rd_cur_reg();
  // u16 lum = rd_lum_reg();
  // u16 ofs = rd_offset_reg();
  // delay(100);
  // MySerial_esp32.println("cosSerial test!!!");
  // MySerial_esp32.print("ID:");
  // MySerial_esp32.println(ID);
  // delay(100);
  // MySerial_esp32.print("ÁîµÊµÅ:");
  // MySerial_esp32.println(elc);
  // delay(100);
  // MySerial_esp32.print("‰∫ÆÂ∫¶:");
  // MySerial_esp32.println(lum);
  // delay(100);
  // MySerial_esp32.print("ÂÅèÁßª:");
  // MySerial_esp32.println(ofs);
  // delay(500);
  /*
  ============================
  */
  // ÂèëÈÄÅÊï∞ÊçÆ
  // SPI.transfer(0x01); // ÂèëÈÄÅ‰∏Ä‰∏™Â≠óËäÇÁöÑÊï∞ÊçÆ
  /*
  ==========================================
  ÈÄªËæëÂàÜÊûê‰ª™ÊµãËØï
  digitalWrite(PANELD2,HIGH);
  delay(500);
  digitalWrite(PANELD2,LOW);
  delay(500);
  ==========================================
  */
  // delay(100); // Á≠âÂæÖ0.1ÁßíÈíü
}

